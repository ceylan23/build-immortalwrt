name: ç©å®¢äº‘ S805 æœ€ç»ˆç‰ˆ (è¯­æ³•ä¿®å¤)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH è¿æ¥'
        required: false
        default: 'false'
        type: boolean

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€æŸ¥ä»£ç ä»“åº“
      uses: actions/checkout@v4

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL https://is.gd/depend_ubuntu2204_openwrt)
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: å…‹éš† ImmortalWrt æºç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone -q --single-branch --depth=1 --branch $REPO_BRANCH $REPO_URL openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: æ›´æ–°å¹¶å®‰è£… Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # ğŸ”¥ğŸ”¥ğŸ”¥ å¼ºåˆ¶ç”Ÿæˆé…ç½®æ–‡ä»¶ ğŸ”¥ğŸ”¥ğŸ”¥
    - name: ç”Ÿæˆé…ç½®æ–‡ä»¶
      run: |
        cd openwrt
        cat > .config <<EOF
        CONFIG_TARGET_meson8b=y
        CONFIG_TARGET_meson8b_meson8b=y
        CONFIG_TARGET_meson8b_meson8b_DEVICE_thunder-onecloud=y
        CONFIG_TARGET_ROOTFS_TARGZ=y
        CONFIG_TARGET_ROOTFS_SQUASHFS=y
        CONFIG_USES_EXT4=y
        CONFIG_USES_SQUASHFS=y
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb2=y
        CONFIG_PACKAGE_kmod-usb-net=y
        CONFIG_PACKAGE_kmod-usb-ohci=y
        CONFIG_PACKAGE_kmod-usb-uhci=y
        CONFIG_PACKAGE_kmod-usb-net-rndis=y
        CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y
        CONFIG_PACKAGE_kmod-usb-net-cdc-ncm=y
        CONFIG_PACKAGE_kmod-usb-net-huawei-cdc-ncm=y
        CONFIG_PACKAGE_kmod-usb-net-ipheth=y
        CONFIG_PACKAGE_usbmuxd=y
        CONFIG_PACKAGE_libimobiledevice=y
        CONFIG_PACKAGE_usbutils=y
        CONFIG_PACKAGE_python3=y
        CONFIG_PACKAGE_python3-base=y
        CONFIG_PACKAGE_python3-pip=y
        CONFIG_PACKAGE_python3-light=y
        CONFIG_PACKAGE_luci-app-turboacc=y
        CONFIG_PACKAGE_luci-app-turboacc_INCLUDE_OFFLOADING=y
        CONFIG_PACKAGE_luci-app-turboacc_INCLUDE_BBR_CCA=y
        CONFIG_PACKAGE_luci-app-turboacc_INCLUDE_SHORTCUT_FE=y
        CONFIG_PACKAGE_kmod-tcp-bbr=y
        CONFIG_PACKAGE_kmod-fs-ext4=y
        CONFIG_PACKAGE_kmod-fs-vfat=y
        CONFIG_PACKAGE_kmod-fs-exfat=y
        CONFIG_PACKAGE_kmod-fs-ntfs3=y
        CONFIG_PACKAGE_automount=y
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_wget-ssl=y
        CONFIG_PACKAGE_htop=y
        CONFIG_PACKAGE_nano=y
        CONFIG_PACKAGE_bash=y
        CONFIG_PACKAGE_openssh-sftp-server=y
        CONFIG_PACKAGE_unzip=y
        CONFIG_PACKAGE_screen=y
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-base=y
        CONFIG_PACKAGE_luci-ssl=y
        CONFIG_PACKAGE_luci-mod-admin-full=y
        CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y
        CONFIG_PACKAGE_luci-theme-argon=y
        CONFIG_PACKAGE_luci-app-upnp=y
        CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y
        CONFIG_PACKAGE_luci-app-autoreboot=y
        CONFIG_PACKAGE_luci-i18n-autoreboot-zh-cn=y
        EOF

    - name: ä¸‹è½½ä¾èµ–åŒ…
      id: package
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: æ•´ç†è¾“å‡ºæ–‡ä»¶
      id: organize
      # ğŸ”¥ ä¿®å¤ç‚¹ï¼šè¿™é‡ŒåŠ ä¸Šäº† ${{ }} é˜²æ­¢ YAML è§£æé”™è¯¯ ğŸ”¥
      if: ${{ !cancelled() }}
      run: |
        # åªè¦ bin ç›®å½•å­˜åœ¨å°±ç®—æˆåŠŸ
        if [ -d "openwrt/bin" ]; then
          echo "FIRMWARE=$PWD/openwrt/bin" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "é”™è¯¯ï¼šbin ç›®å½•ä¸å­˜åœ¨ï¼"
          exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OneThing_S805_${{ env.FILE_DATE }}
        path: openwrt/bin/targets/**/*

    - name: å‘å¸ƒ Release
      uses: softprops/action-gh-release@v1
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        tag_name: ${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin/targets/**/*
